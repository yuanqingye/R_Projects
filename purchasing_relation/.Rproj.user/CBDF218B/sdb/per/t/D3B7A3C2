{
    "contents" : "---\ntitle: \"weekly_report\"\nauthor: \"qingye\"\noutput: html_document\n---\n## 首先是最近两周的pv和uv\n\n```{r user_pv_uv,echo = FALSE}\nlibrary(plotrix)\nlibrary(data.table)\ndateend = Sys.Date()-1\ndatestart = Sys.Date()-14\ndatestart.str = format(datestart,'%Y%m%d')\ndateend.str = format(dateend,'%Y%m%d')\ndates = datestart.str:dateend.str\nsource('~/Rfile/R_impala.R')\nquery1 = paste0(\"select * from dm.dm_totaldailyreport where dt>=\",datestart.str,\" and dt<=\",dateend.str)\ntotal_daily_report = read_data_impala_general(query1)\ntotal_daily_report = data.table(total_daily_report)\nsetorder(total_daily_report,cols = 'dt')\n\nldigits = nchar(median(total_daily_report$tuv))-1\nrdigits = nchar(median(total_daily_report$tpv))-1\nlrange = range(total_daily_report$tuv)+c(-`^`(10,ldigits),`^`(10,ldigits))\nrrange = range(total_daily_report$tpv)+c(-`^`(10,rdigits),`^`(10,rdigits))\n\npar(bg = 'black')\ntwoord.plot(dates,total_daily_report$tuv,dates,total_daily_report$tpv,ylab='uv',\n            rylab = 'pv',xlab = 'date',main = \"近两周流量情况\",\n            lylim = lrange,rylim = rrange,\n            lcol='green',\n            rcol ='red'\n)\n\nlegend('topleft',legend = c('uv','pv'),fill = c('green','red'),text.col = 'pink',cex = 1.5)\n\naxis(1,col = 'blue')\nat = axTicks(1)\nmtext(side = 1, text = at, at = at, col = \"blue\", line = 1)\n\ntitle(main = '近两周流量情况',col.main = 'blue')\navgpv = round(mean(total_daily_report$tpv))\navguv = round(mean(total_daily_report$tuv))\nmaxpv = max(total_daily_report$tpv)\nmaxuv = max(total_daily_report$tuv)\n\ntext(dates[7],mean(c(lrange[2],maxuv)),paste0('本周UV峰值',maxuv,' 均值',avguv,\n      ' \\n本周PV峰值',maxpv,' 均值',avgpv),col = 'orange')\n```\n\n\n## 以下是关于用户激活的情况\n\n```{r user_active, echo=FALSE}\nquery2 = paste0(\"select * from dm.dm_totaldailyactive where dt>=\",datestart.str,\n               \" and dt<=\",dateend.str)\ntotal_daily_active = read_data_impala_general(query2)\ntotal_daily_active = data.table(total_daily_active)\nsetorder(total_daily_active,cols = 'dt')\n\ncol_num = ncol(total_daily_active)\ntotal_daily_active$sum = rowSums(total_daily_active[,-col_num,with = F])\ndigits = nchar(round(median(total_daily_active$sum)))-1\nrange = range(total_daily_active$sum)+c(-`^`(10,digits),`^`(10,digits))\ntotal_daily_active_draw = total_daily_active\ntotal_daily_active_draw[,c('marketpromotion','offlinemarket','dt'):=NULL,]\ncolors = rainbow(6)\npar(bg = 'black')\nplot(x=dates,y=total_daily_active_draw[,1][[1]],ylim = c(0,range[2]),\n     type = 'o',col = colors[[1]],pch = 3,axes = FALSE)\nlines(x=dates,y=total_daily_active_draw[,2][[1]],type = 'b',col = colors[[2]],pch = 4)\nlines(x=dates,y=total_daily_active_draw[,3][[1]],type = 'b',col = colors[[3]],pch = 5)\nlines(x=dates,y=total_daily_active_draw[,4][[1]],type = 'b',col = colors[[4]],pch = 6)\nlines(x=dates,y=total_daily_active_draw[,5][[1]],type = 'b',col = colors[[5]],pch = 7)\nlines(x=dates,y=total_daily_active_draw[,6][[1]],type = 'b',col = colors[[6]],pch = 8)\n\nlegend('topleft',colnames(total_daily_active_draw),cex = 0.7,fill = colors,text.col= 'pink')\n\n#需要加入坐标轴\ntitle(main = '近两周激活情况',xlab = 'dates',ylab = '激活数',col.main = 'blue',\n      col.lab = 'purple')\naxis(1,col = 'purple')\nat = axTicks(1)\nmtext(side = 1, text = at, at = at, col = \"purple\", line = 1)\n\naxis(2,col = 'purple')\nat = axTicks(2)\nmtext(side = 2,text = at,at = at,col = 'purple',line = 1)\n\n\n#计算激活指标\nlastweek_total_active = sum(total_daily_active[1:7,'sum'])\nthisweek_total_active = sum(total_daily_active[8:14,'sum'])\nlink_relative_ratio_active = round(thisweek_total_active/lastweek_total_active,2)\n\ntext(dates[10],mean(c(range[2],max(total_daily_active$sum))),\n     paste0('上周激活数   ',lastweek_total_active,'   \\n本周激活数   ',thisweek_total_active,'   \\n周环比   ',link_relative_ratio_active*100,'%'),col = 'orange')\n\n```\n\n\n## 察看用户注册的情况\n\n```{r user_registry, echo=FALSE}\nquery3 = paste0(\"select * from dl.openid_firstonlinetime where dt='\",format(Sys.Date()-1,'%Y%m%d'),\"' and substring(firstonlinetime,1,10)>='\",format(Sys.Date()-14,'%Y-%m-%d'),\"' and substring(firstonlinetime,1,10)<='\",format(Sys.Date()-1,'%Y-%m-%d'),\"'\")\nuser_registry = read_data_impala_general(query3)\nuser_registry = data.table(user_registry)\nsetorder(user_registry,cols = 'firstonlinetime')\nuser_registry[,date:=substr(firstonlinetime,1,10)]\nuser_registry[,date:=as.Date(date,format = '%Y-%m-%d')]\nuser_registry_count = user_registry[,.N,by = 'date']\npar(bg = 'black')\nplot(dates,user_registry_count$N,type = 'b',col= 'red',xlab = 'dates',\n     ylab = '注册数',axes = FALSE,lwd = 2,pch = '*')\n\naxis(1,col = 'blue')\nat = axTicks(1)\nmtext(side = 1, text = at, at = at, col = \"blue\", line = 1)\n\naxis(2,col = 'blue')\nat = axTicks(2)\nmtext(side = 2, text = at, at = at, col = \"blue\", line = 1)\n\ntitle(main = '近两周新注册数',xlab = 'dates',ylab = '注册数',col.main = 'red',\n      col.lab = 'blue')\n\n#计算注册指标\nlastweek_total_registry = sum(user_registry_count[1:7,'N'])\nthisweek_total_registry = sum(user_registry_count[8:14,'N'])\nlink_relative_ratio_registry = round(thisweek_total_registry/lastweek_total_registry,2)\ntext(dates[7],max(user_registry_count$N),\n     paste0('上周新增注册数  ',lastweek_total_registry,'  本周新增注册数 ',thisweek_total_registry,' 周环比 ',link_relative_ratio_registry*100,'%'),col = 'orange')\n\n\n```",
    "created" : 1499222545404.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2324869099",
    "id" : "D3B7A3C2",
    "lastKnownWriteTime" : 1498718508,
    "path" : "~/R_Projects/weekly_report/R_markdown/weekly_report.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "type" : "r_markdown"
}