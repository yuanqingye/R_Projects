{
    "collab_server" : "",
    "contents" : "# install.packages(\"rJava\")\n# \n# install.packages(\"DBI\")\n# \n# install.packages(\"RJDBC\")\n\nlibrary(DBI)\n\nlibrary(rJava)\n\nlibrary(RJDBC)\n\ncp = c(list.files(\"~/libs\",pattern=\"jar$\",full.names=T))\n\ndrv <- JDBC(\"org.apache.hive.jdbc.HiveDriver\", cp)\n\nconn <- dbConnect(drv, \"jdbc:hive2://172.16.107.129:10000/user_center\", \"\", \"\")\n\nquery = \"select ordr_date,mall_name,shop_name,ordr_id,d.open_id,cust_id,cust_name,is_promotion,address,ordr_status,d.mobile,d.prov_name,d.city,cat3_name,\nprod_name,amt,discnt_amt,is_coupon,coupon_type,coupon_theme_name,coupon_amt,coupon_theme_desc,partner_code,partner_name,booth_id,\nbooth_desc,cont_cat1_name,cont_cat2_name,cont_cat3_name,cont_main_brand_name,cont_series_name,cont_floor_name,sale_type,ordr_type,\nc.u_mid from dl.fct_ordr d left join ods.ods_db_user_center_users_dt b on d.mobile=b.mobile left join(select * from dl.dl_channel_umid where dt='20170601') c on b.openid=c.openid\nwhere to_date(ordr_date)>='2017-05-25' and to_date(ordr_date)<='2017-05-31'\"\n\n# order_data_4 = dbGetQuery(con,query)\n\npage_view_query1 = \"select * from (select d.page_name,p.system_time,p.path,p.service,p.ts,p.p_domain,p.p_channel,p.p_type,p.p_item,p.p_title,p.u_id,p.u_mid,p.u_guid,p.l_ip,p.l_city from ods.ods_app_pageview_info p inner join test.path_dict d on p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and p.p_item = d.p_item and l_ip!='210.13.91.146' and p.service in ('h5.pvuv','ios.pvuv','android.pvuv') and substr(p.u_mid,1,2)!='a_' and p.path='p' and l_city!='????' and p.p_domain='mmall.com' and p.p_type not in ('page.closedown','page.wakeup','page.activate.main') and dt=20170501) t1,(select percentile(cast(ts as bigint),0) quarter0,percentile(cast(ts as bigint),0.25) quarter1,percentile(cast(ts as bigint),0.5) quarter2,percentile(cast(ts as bigint),0.75) quarter3,percentile(cast(ts as bigint),1) quarter4 from ods.ods_app_pageview_info i where i.path='p' and i.dt = 20170501) t2 where cast(t1.ts as bigint)>= quarter0 and cast(t1.ts as bigint)<quarter1\"\npage_view_query2 = \"select * from (select d.page_name,p.system_time,p.path,p.service,p.ts,p.p_domain,p.p_channel,p.p_type,p.p_item,p.p_title,p.u_id,p.u_mid,p.u_guid,p.l_ip,p.l_city from ods.ods_app_pageview_info p inner join test.path_dict d on p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and p.p_item = d.p_item and l_ip!='210.13.91.146' and p.service in ('h5.pvuv','ios.pvuv','android.pvuv') and substr(p.u_mid,1,2)!='a_' and p.path='p' and l_city!='????' and p.p_domain='mmall.com' and p.p_type not in ('page.closedown','page.wakeup','page.activate.main') and dt=20170501) t1,(select percentile(cast(ts as bigint),0) quarter0,percentile(cast(ts as bigint),0.25) quarter1,percentile(cast(ts as bigint),0.5) quarter2,percentile(cast(ts as bigint),0.75) quarter3,percentile(cast(ts as bigint),1) quarter4 from ods.ods_app_pageview_info i where i.path='p' and i.dt = 20170501) t2 where cast(t1.ts as bigint)>= quarter1 and cast(t1.ts as bigint)<quarter2\"\npage_view_query3 = \"select * from (select d.page_name,p.system_time,p.path,p.service,p.ts,p.p_domain,p.p_channel,p.p_type,p.p_item,p.p_title,p.u_id,p.u_mid,p.u_guid,p.l_ip,p.l_city from ods.ods_app_pageview_info p inner join test.path_dict d on p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and p.p_item = d.p_item and l_ip!='210.13.91.146' and p.service in ('h5.pvuv','ios.pvuv','android.pvuv') and substr(p.u_mid,1,2)!='a_' and p.path='p' and l_city!='????' and p.p_domain='mmall.com' and p.p_type not in ('page.closedown','page.wakeup','page.activate.main') and dt=20170501) t1,(select percentile(cast(ts as bigint),0) quarter0,percentile(cast(ts as bigint),0.25) quarter1,percentile(cast(ts as bigint),0.5) quarter2,percentile(cast(ts as bigint),0.75) quarter3,percentile(cast(ts as bigint),1) quarter4 from ods.ods_app_pageview_info i where i.path='p' and i.dt = 20170501) t2 where cast(t1.ts as bigint)>= quarter2 and cast(t1.ts as bigint)<quarter3\"\npage_view_query4 = \"select * from (select d.page_name,p.system_time,p.path,p.service,p.ts,p.p_domain,p.p_channel,p.p_type,p.p_item,p.p_title,p.u_id,p.u_mid,p.u_guid,p.l_ip,p.l_city from ods.ods_app_pageview_info p inner join test.path_dict d on p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and p.p_item = d.p_item and l_ip!='210.13.91.146' and p.service in ('h5.pvuv','ios.pvuv','android.pvuv') and substr(p.u_mid,1,2)!='a_' and p.path='p' and l_city!='????' and p.p_domain='mmall.com' and p.p_type not in ('page.closedown','page.wakeup','page.activate.main') and dt=20170501) t1,(select percentile(cast(ts as bigint),0) quarter0,percentile(cast(ts as bigint),0.25) quarter1,percentile(cast(ts as bigint),0.5) quarter2,percentile(cast(ts as bigint),0.75) quarter3,percentile(cast(ts as bigint),1) quarter4 from ods.ods_app_pageview_info i where i.path='p' and i.dt = 20170501) t2 where cast(t1.ts as bigint)>= quarter3\"\n\n# data_hive_501_2 <- dbGetQuery(con, page_view_query2)\n# data_hive_501_3 <- dbGetQuery(con, page_view_query3)\n# data_hive_501_4 <- dbGetQuery(con, page_view_query4)\n\nassignfunction = function(datestr) {\n  page_view_query1 = paste0(\n    \"select * from (select d.page_name,p.system_time,p.path,p.service,p.ts,p.p_domain,p.p_channel,p.p_type,p.p_item,p.p_title,p.u_id,p.u_mid,p.u_guid,p.l_ip,p.l_city from ods.ods_app_pageview_info p inner join test.path_dict d on p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and p.p_item = d.p_item and l_ip!='210.13.91.146' and p.service in ('h5.pvuv','ios.pvuv','android.pvuv') and substr(p.u_mid,1,2)!='a_' and p.path='p' and l_city!='????' and p.p_domain='mmall.com' and p.p_type not in ('page.closedown','page.wakeup','page.activate.main') and dt=\",datestr,\") t1,(select percentile(cast(ts as bigint),0) quarter0,percentile(cast(ts as bigint),0.25) quarter1,percentile(cast(ts as bigint),0.5) quarter2,percentile(cast(ts as bigint),0.75) quarter3,percentile(cast(ts as bigint),1) quarter4 from ods.ods_app_pageview_info i where i.path='p' and i.dt = \",datestr,\") t2 where cast(t1.ts as bigint)>= quarter0 and cast(t1.ts as bigint)<quarter1\"\n  )\n  page_view_query2 = paste0(\n    \"select * from (select d.page_name,p.system_time,p.path,p.service,p.ts,p.p_domain,p.p_channel,p.p_type,p.p_item,p.p_title,p.u_id,p.u_mid,p.u_guid,p.l_ip,p.l_city from ods.ods_app_pageview_info p inner join test.path_dict d on p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and p.p_item = d.p_item and l_ip!='210.13.91.146' and p.service in ('h5.pvuv','ios.pvuv','android.pvuv') and substr(p.u_mid,1,2)!='a_' and p.path='p' and l_city!='????' and p.p_domain='mmall.com' and p.p_type not in ('page.closedown','page.wakeup','page.activate.main') and dt=\",datestr,\") t1,(select percentile(cast(ts as bigint),0) quarter0,percentile(cast(ts as bigint),0.25) quarter1,percentile(cast(ts as bigint),0.5) quarter2,percentile(cast(ts as bigint),0.75) quarter3,percentile(cast(ts as bigint),1) quarter4 from ods.ods_app_pageview_info i where i.path='p' and i.dt = \",datestr,\") t2 where cast(t1.ts as bigint)>= quarter1 and cast(t1.ts as bigint)<quarter2\"\n  )\n  page_view_query3 = paste0(\n    \"select * from (select d.page_name,p.system_time,p.path,p.service,p.ts,p.p_domain,p.p_channel,p.p_type,p.p_item,p.p_title,p.u_id,p.u_mid,p.u_guid,p.l_ip,p.l_city from ods.ods_app_pageview_info p inner join test.path_dict d on p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and p.p_item = d.p_item and l_ip!='210.13.91.146' and p.service in ('h5.pvuv','ios.pvuv','android.pvuv') and substr(p.u_mid,1,2)!='a_' and p.path='p' and l_city!='????' and p.p_domain='mmall.com' and p.p_type not in ('page.closedown','page.wakeup','page.activate.main') and dt=\",datestr,\") t1,(select percentile(cast(ts as bigint),0) quarter0,percentile(cast(ts as bigint),0.25) quarter1,percentile(cast(ts as bigint),0.5) quarter2,percentile(cast(ts as bigint),0.75) quarter3,percentile(cast(ts as bigint),1) quarter4 from ods.ods_app_pageview_info i where i.path='p' and i.dt = \",datestr,\") t2 where cast(t1.ts as bigint)>= quarter2 and cast(t1.ts as bigint)<quarter3\"\n  )\n  page_view_query4 = paste0(\n    \"select * from (select d.page_name,p.system_time,p.path,p.service,p.ts,p.p_domain,p.p_channel,p.p_type,p.p_item,p.p_title,p.u_id,p.u_mid,p.u_guid,p.l_ip,p.l_city from ods.ods_app_pageview_info p inner join test.path_dict d on p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and p.p_item = d.p_item and l_ip!='210.13.91.146' and p.service in ('h5.pvuv','ios.pvuv','android.pvuv') and substr(p.u_mid,1,2)!='a_' and p.path='p' and l_city!='????' and p.p_domain='mmall.com' and p.p_type not in ('page.closedown','page.wakeup','page.activate.main') and dt=\",datestr,\") t1,(select percentile(cast(ts as bigint),0) quarter0,percentile(cast(ts as bigint),0.25) quarter1,percentile(cast(ts as bigint),0.5) quarter2,percentile(cast(ts as bigint),0.75) quarter3,percentile(cast(ts as bigint),1) quarter4 from ods.ods_app_pageview_info i where i.path='p' and i.dt = \",datestr,\") t2 where cast(t1.ts as bigint)>= quarter3\"\n  )\n  for (i in 1:4) {\n    assign(paste0('data_hive_',substr(datestr,6,8),'_',i),dbGetQuery(con,eval(as.name(\n      paste0('page_view_query',i)\n    ))),pos = .GlobalEnv)\n  }\n  assign(paste0('data_hive_',substr(datestr,6,8)),rbind(eval(as.name(\n    paste0('data_hive_',substr(datestr,6,8),'_',1)\n  )),eval(as.name(paste0(\n    'data_hive_',substr(datestr,6,8),'_',2\n  ))),eval(as.name(paste0(\n    'data_hive_',substr(datestr,6,8),'_',3\n  ))),eval(as.name(paste0(\n    'data_hive_',substr(datestr,6,8),'_',4\n  )))),pos = .GlobalEnv)\n  l = c(paste0('data_hive_',substr(datestr,6,8),'_',1),paste0('data_hive_',substr(datestr,6,8),'_',2),paste0('data_hive_',substr(datestr,6,8),'_',3),paste0('data_hive_',substr(datestr,6,8),'_',4))\n  rm(list = l,pos = .GlobalEnv)\n}\n\nread_data_hive_general = function(sql){\n  data = dbGetQuery(conn,sql)\n  return(data)\n}\n\n# data_hive_502 = rbind(data_hive_502_1,data_hive_502_2,data_hive_502_3,data_hive_502_4)\n\n# rmfunction = function(datestr,partnum){\n#   for(i in 1:partnum){\n#     name = paste0('data_hive_',datestr,'_',i)\n#     v = as.name(name)\n#     rm(v)\n#   }\n# }\n\n# assignfunction = function(a){\n#   vvv<<-a\n# }\n# \n# summary(data)",
    "created" : 1505977821534.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2230770109",
    "id" : "F40B56B6",
    "lastKnownWriteTime" : 1513939066,
    "last_content_update" : 1513939066685,
    "path" : "~/Rfile/R_hive.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}