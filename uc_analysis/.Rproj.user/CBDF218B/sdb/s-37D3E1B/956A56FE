{
    "collab_server" : "",
    "contents" : "-- 建立字典表\n\"CREATE TABLE test.path_dict\nAS\nSELECT DISTINCT split(b.value,' ')[0] AS path, \nsplit(c.value,' ')[0] AS p_domain,\nsplit(d.value,' ')[0] AS p_channel,\na.page_mark,\na.page_name_en AS p_type,\na.p_item,a.page_name_zh as page_name\nFROM dl.dl_data_point_rule_t_rule_dt a \nLEFT JOIN dl.dl_data_point_rule_t_code_dt b \nON a.path_type_value=b.id AND b.status=1 \nLEFT JOIN dl.dl_data_point_rule_t_code_dt c\nON a.p_domain_type_value=c.id AND c.status=1 \nLEFT JOIN dl.dl_data_point_rule_t_code_dt d \nON a.p_channel_type_value=d.id AND d.status=1 \nWHERE a.status=1 -- AND split(b.value,' ')[0] in ('f','p')\nORDER BY path,p_domain,p_channel,p_type\"\n\n# 关联得出包含中文名的数据\n\"create table test.uc_record_to_531 AS\nselect page_name,p.p_type,p.path,p.p_item,p.p_channel,dt,app_v,service,\np_stay_time,p_live_time,d_os,ts,p_url,page_mark,u_mid from \nods.ods_app_pageview_info p inner join test.path_dict d\non p.p_type = d.p_type and p.page = d.page_mark and p.path = d.path and \np.p_item = d.p_item where p.app_v in ('2.0.4','2.0.5','2.0.6') and \np.p_domain = 'mmall.com' and \n(p.p_type like '%user' or page_name like '%中心%' or p.p_type like '%.uc.%') and \ndt between 20170508 and 20170531\"\n-- 数据清洗\nuc_record_to_531_copy = uc_record_to_531\nuc_record_to_531[,value :=1]\n\n-- 各个页面 #pv uv\nuc_record_pv_by_pagename = uc_record_to_531[,.(pv = .N),by=c('page_name','p.p_type','p.path')]\nuc_record_pv_by_pagename_p = uc_record_to_531[p.path=='p',.(pv = sum(value)),by=c('page_name','p.p_type')]\nuc_record_pv_by_pagename_f = uc_record_to_531[p.path=='f',.(pv = sum(value)),by=c('page_name','p.p_type')]\nuc_record_pv_by_pagename_sorted = uc_record_pv_by_pagename[order(uc_record_pv_by_pagename$pv,decreasing = T),]\nuc_record_pv_by_pagename_p_sorted = uc_record_pv_by_pagename_p[order(uc_record_pv_by_pagename_p$pv,decreasing = T),]\nuc_record_pv_by_pagename_f_sorted = uc_record_pv_by_pagename_f[order(uc_record_pv_by_pagename_f$pv,decreasing = T),]\n\n\nuc_record_to_531_user = unique(uc_record_to_531,by = c('page_name','u_mid','p.p_type','p.path','p.p_item','p.p_channel'))\nuc_record_uv_by_pagename_p = uc_record_to_531_user[p.path=='p',.(uv = .N),by = c('page_name','p.p_type')]\nuc_record_uv_by_pagename_f = uc_record_to_531_user[p.path=='f',.(uv = .N),by = c('page_name','p.p_type')]\nuc_record_uv_by_pagename_p_sorted = uc_record_uv_by_pagename_p[order(uc_record_uv_by_pagename_p$uv,decreasing = T),]\nuc_record_uv_by_pagename_f_sorted = uc_record_uv_by_pagename_f[order(uc_record_uv_by_pagename_f$uv,decreasing = T),]\n\n\n#pv 作图\npv_pic = uc_record_pv_by_pagename_p_sorted[1:7,]\n# library(plotrix)\n# pie(pv_pic$pv,labels=pv_pic$page_name,main=\"用户中心各主要页面pv\")\ncols=rainbow(length(page_name))\nbarplot(pv_pic$pv,names.arg = page_name,col = cols,xlab = '页面名称',ylab='pv值',main='pv值分页面统计')\n\n#uv 作图\nuv_pic = uc_record_uv_by_pagename_p_sorted[1:7,]\nbarplot(uv_pic$uv,names.arg = page_name,col = cols,xlab = '页面名称',ylab='uv值',main='uv值分页面统计')\n\n--总跳转率\nrate_uc2mc = uc_record_pv_by_pagename_p[page_name=='个人中心首页',pv]/uc_record_pv_by_pagename_p[page_name=='个人中心首页-会员中心主页',pv]\nrate_mc2uc = 1/rate_uc2mc\n\nmc_pv = uc_record_pv_by_pagename_p[page_name=='个人中心首页-会员中心主页',pv]\nuc_pv = uc_record_pv_by_pagename_p[page_name=='个人中心首页',pv]\n\npie3D(c(mc_pv,(uc_pv-mc_pv)),labels = c(paste('会员中心点击数',100*(round(rate_mc2uc,3)),'%'),'用户中心点击数'),main = '跳转率pv')\n\nmc_uv = uc_record_uv_by_pagename_p[page_name=='个人中心首页-会员中心主页',uv]\nuc_uv = uc_record_uv_by_pagename_p[page_name=='个人中心首页',uv]\n\npie3D(c(mc_uv,(uc_uv-mc_uv)),labels = c(paste('会员中心点击人数',100*(round(mc_uv/uc_uv,3)),'%'),'用户中心点击人数'),main = '跳转率uv')\n\n-- 用户任务完成情况\n# DELIVERY_ADDRESS\n# 803\n# FIRST_COMMENT\n# 22\n# FIRST_SHOPPING\n# 132274\n# PERSONAL_INFO\n# 1933\n# select * from dl.fct_ordr where date_id between date('2017-05-08') and date('2017-05-31') and sale_type = 'C端' and ordr_status not in (1,7,19);\n\ntask_complete = data.table(task_name = c('地址完善','第一次评论','第一次购物','个人信息完善'),num = c(803,22,32,1933))\ncolors <- c(\"green\",\"orange\",\"brown\",\"blue\")\nbarplot(task_complete$num,main=\"任务完成状态\",names.arg=task_complete$task_name,xlab=\"taskname\",ylab=\"number\",col=colors)\n\n-- 重返情况\nuc_record_main = uc_record_to_531[page_name == '个人中心首页',]\nuc_record_pagecount_by_user = uc_record_main[,.(count = .N),by = c('u_mid')]\nuc_record_pagecount_by_user_date = uc_record_main[,.(count = .N),by = c('u_mid','dt')]\nuc_record_comeback = uc_record_pagecount_by_user_date[,.(count = .N),by = c('u_mid')]\nnot_comeback_num = nrow(uc_record_comeback[count == 1,])#20919\ntotal_num = nrow(uc_record_comeback) #24264\ncomeback_num = total_num - comeback_num\n#13.8% 重返率\n#做饼图\npie3D(c(comeback_num,not_comeback_num),labels = c('重返用户中心用户13.8%','不重返用户中心用户86.2%'),main = '重返率饼状图')\n\n--平均时长\nuc_record_stay_time = uc_record_to_531[!is.na(p_stay_time),]\nuc_record_stay_time[,p_stay_time := as.numeric(p_stay_time)]\nuc_record_stay_time_summarize = uc_record_stay_time[,.(totaltime = sum(p_stay_time)/1000,count=.N),by = c('page_name')]\nuc_record_stay_time_avg = uc_record_stay_time_summarize[,avg:=totaltime/count]\ncols = rainbow(nrow(uc_record_stay_time_avg))\npage_name = c('我的福利包页面','会员中心主页','会员等级页面','积分兑换页面','会员权益页面')\nbarplot(uc_record_stay_time_avg$avg,main=\"页面访问平均时长(秒) \",names.arg=page_name,xlab=\"页面名称\",ylab=\"停留时长\",col=cols)\n\n-- 每日签到数\n# uc_sign = read_xlsx('~/data/sign.xlsx')\n# uc_sign = data.table(uc_sign)\n  uc_sign_bydate = setorder(uc_sign[,.(count=.N),by = 'sign_date'],sign_date)\n#  uc_sign_byuser = setorder(uc_sign[,.(count=.N),by = 'user_id'],-count)\n  注意没有任何一个人签到过两次\n\n#使用线点结合作图\nplot(y=uc_sign_bydate_may$count,x=11:31,type = 'h',main='每日签到数',xlab = '日期',ylab='签到人数',col='red',lwd = 10)\n\n-- 权益获取\nuc_rights = read_xlsx('~/data/rights.xlsx')\nuc_rights = data.table(uc_rights[1:6,c('rights_name','repertory_total','already_use_total')])\nuc_rights[,already_use_total:=as.numeric(already_use_total)]\nuc_rights[,repertory_total:=as.numeric(repertory_total)]\nuc_rights[,rate :=  already_use_total/repertory_total]\n#打算使用堆积柱表\nrights_name = c('床垫除螨上海','床垫除螨北京','爱奇异50元抵用券','爱奇异五折','电影折扣','地板保养上海')\nValues = t(as.matrix(uc_rights[,c('repertory_total','already_use_total')]))\nrow3 = Values[1,]-Values[2,]\nValues = rbind(Values,row3)\nValues = Values[c(3,2),]\ncolors = c('green','purple')\nusage= c('未使用','已使用')\nbarplot(Values,main=\"权益领取\",names.arg=rights_name,xlab=\"权益名称\",ylab=\"数量\",col=colors)\nlegend(\"topleft\", usage, cex=1.3, fill=colors)\n\n-- 积分兑换礼物\nuc_gifts = read_xlsx('~/data/gifts.xlsx')\nuc_gifts_repertory = read_xlsx('~/data/gifts_repertory.xlsx')\nuc_gifts_wide = merge(uc_gifts,uc_gifts_repertory,by.x='id',by.y='gift_id')\nuc_gifts_wide_copy = uc_gifts_wide\nuc_gifts_wide = data.table(uc_gifts_wide)\nuc_gifts_wide[,use_start_time:=as.Date(use_start_time)]\nuc_gifts_wide[,use_end_time:=as.Date(use_end_time)]\nuc_gifts_check = uc_gifts_wide[use_start_time!='\\\\N--hive-import',]\n# uc_gifts_use = uc_gifts_wide_copy[already_use_total>0,]\nuc_gifts_use = uc_gifts_check[,c('name','specification','cost_score','use_start_time','use_end_time','quantity','already_use_total')]\nuc_gifts_use[,already_use_total := as.numeric(already_use_total)]\nuc_gifts_use[,quantity:=as.numeric(quantity)]\nuc_gifts_use[,rate:=already_use_total/quantity]\n#打算使用堆积柱表\ngifts_name = c('12日发放电影券','26日发放电影券')\nValues2 = t(as.matrix(uc_gifts_pick[,c('quantity','already_use_total')]))\nRow3 = Values2[1,]-Values2[2,]\nValues2 = rbind(Values2,Row3)\nValues2 = Values2[c(3,2),c(2,1)]\ncolors = c('green','purple')\nusage2= c('未兑换','已兑换')\nbarplot(Values2,main=\"积分兑换礼物\",names.arg=gifts_name,xlab=\"礼物名称\",ylab=\"数量\",col=colors)\nlegend(\"topleft\", usage2, cex=1.3, fill=colors)",
    "created" : 1496305872442.000,
    "dirty" : false,
    "encoding" : "GB18030",
    "folds" : "",
    "hash" : "710423721",
    "id" : "956A56FE",
    "lastKnownWriteTime" : 1496392113,
    "last_content_update" : 0,
    "path" : "~/R_Projects/uc_analysis/uc_analysis.R",
    "project_path" : "uc_analysis.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}