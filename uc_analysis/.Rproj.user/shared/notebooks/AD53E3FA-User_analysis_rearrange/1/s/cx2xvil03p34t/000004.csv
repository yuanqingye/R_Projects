"0","# datestart = as.Date(""2017-12-02"",""%Y-%m-%d"")"
"0","# dateend = datestart+14"
"0","# datestart.str = format(datestart,'%Y%m%d')"
"0","# dateend.str = format(dateend,'%Y%m%d')"
"0","# ldateend = datestart-1"
"0","# ldatestart = datestart-15"
"0","# ldatestart.str = format(ldatestart,'%Y%m%d')"
"0","# ldateend.str = format(ldateend,'%Y%m%d')"
"0","new_user_by_model_date_city_sql = "
"0","paste0(""select count(b.u_mid) numbers,firstdt,d_model,l_city from"
"0","(select f.u_mid,substr(firstonlinetime,1,10) firstdt,a.d_model,a.l_city from dl.umid_firstonlinetime f left join"
"0","  (select * from"
"0","  (select u_mid,d_model,l_city,ROW_NUMBER() OVER (PARTITION BY u_mid,d_model,l_city ORDER BY dt) "
"0","       as level from ods.ods_app_pageview_info where dt>="",ldatestart.str,"") t where t.level = 1) a"
"0","  using(u_mid) where substr(firstonlinetime,1,10) >= '"",as.character(ldatestart),""' "
"0","  and f.dt = '"",dateend.str,""') b group by firstdt,d_model,l_city"")"
"0","new_user_by_model_date_city = read_data_impala_general(new_user_by_model_date_city_sql)"
"0","new_user_by_model_date_city = data.table(new_user_by_model_date_city)"
"0","lnew_user_by_model_date_city = new_user_by_model_date_city[firstdt < as.character(datestart),]"
"0","new_user_by_model_date_city = new_user_by_model_date_city[firstdt >= as.character(datestart),]"
"0","new_user_by_model_date = new_user_by_model_date_city[d_model!=""null"" & str_trim(d_model)!="""",.(numbers = sum(numbers)),by = c(""d_model"",""firstdt"")]"
"0","new_user_by_model = new_user_by_model_date_city[d_model!=""null"" & str_trim(d_model)!="""",.(numbers = sum(numbers)),by = ""d_model""][order(numbers,decreasing = T)]"
"0","model_list = new_user_by_model[1:100,]$d_model"
"0","new_user_by_model_date_top100 = new_user_by_model_date[d_model %in% model_list,]"
"0","new_user_by_model_date_top100$model = factor(new_user_by_model_date_top100$d_model,levels = model_list)"
"0","new_user_by_model_date_top100_ordered = new_user_by_model_date_top100[order(firstdt,model)]"
"0","# new_user_by_model_date_ordered_reshape = reshape(new_user_by_model_date_top100_ordered, idvar = ""model"", timevar = ""firstdt"", direction = ""wide"")"
"0","new_user_by_model_date_ordered_reshape = dcast(new_user_by_model_date_top100_ordered, model ~ firstdt, value.var = ""numbers"")"
"0","new_user_by_model_date_ordered_reshape$sum =rowSums(new_user_by_model_date_ordered_reshape[,-1],na.rm = T)"
"0","melt_df_model_top20 = melt(new_user_by_model_date_ordered_reshape[1:20,-ncol(new_user_by_model_date_ordered_reshape)], id.vars = ""model"", measure.vars = 2:(ncol(new_user_by_model_date_ordered_reshape)-1), variable.name = ""date"", value.name = ""value"")"
"0","lmodel_rank = lnew_user_by_model_date_city[d_model!=""null"" & str_trim(d_model)!="""",.(lsum = sum(numbers)),by = c(""d_model"")]"
"0","lmodel_rank$lrank = frank(lmodel_rank,-lsum,ties.method = ""min"")"
"0","new_user_by_model_date_ordered_reshape$rank = seq(new_user_by_model_date_ordered_reshape$sum)"
"0","new_user_by_model_date_ordered_reshape = merge(new_user_by_model_date_ordered_reshape,lmodel_rank,by.x = ""model"",by.y= ""d_model"",all.x = TRUE)"
"0","new_user_by_model_date_ordered_reshape = new_user_by_model_date_ordered_reshape[order(new_user_by_model_date_ordered_reshape$rank),]"
"0","rankchange = new_user_by_model_date_ordered_reshape$lrank - new_user_by_model_date_ordered_reshape$rank"
"0","symrankchange = ifelse(is.na(rankchange)|rankchange==0,"""",ifelse(rankchange>0,intToUtf8(9650),intToUtf8(9660)))"
"0","sym = paste0(rankchange,symrankchange)"
"0","new_user_by_model_date_ordered_reshape$lsum = NULL"
"0","new_user_by_model_date_ordered_reshape$lrank = NULL"
"0","new_user_by_model_date_ordered_reshape = cbind(sym,new_user_by_model_date_ordered_reshape)"
"0","rownames(new_user_by_model_date_ordered_reshape) = 1:nrow(new_user_by_model_date_ordered_reshape)"
"0","DT::datatable(new_user_by_model_date_ordered_reshape, options = list(pageLength = 20))"
