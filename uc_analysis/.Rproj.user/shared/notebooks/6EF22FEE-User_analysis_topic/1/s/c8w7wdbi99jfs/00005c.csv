"0","  survival_sql = paste0(""select "
"0","  a.dt,ndv(a.u_mid) t,"
"0","  ndv(case when datediff(concat(substr(b.dt,1,4),'-',substr(b.dt,5,2),'-',substr(b.dt,7,2)),"
"0","  concat(substr(a.dt,1,4),'-',substr(a.dt,5,2),'-',substr(a.dt,7,2)))=1 then a.u_mid else null end)	t1,"
"0","  ndv(if(a.isnew='new',a.u_mid,null)) newuv ,"
"0","  ndv(case when datediff(concat(substr(b.dt,1,4),'-',substr(b.dt,5,2),'-',substr(b.dt,7,2)),"
"0","  concat(substr(a.dt,1,4),'-',substr(a.dt,5,2),'-',substr(a.dt,7,2)))=1 and a.isnew='new' then a.u_mid else null end) newt1,"
"0","  ndv(if(a.isnew='old',a.u_mid,null)) olduv,"
"0","  ndv(case when  datediff(concat(substr(b.dt,1,4),'-',substr(b.dt,5,2),'-',substr(b.dt,7,2)),"
"0","  concat(substr(a.dt,1,4),'-',substr(a.dt,5,2),'-',substr(a.dt,7,2)))=1  and a.isnew='old' then a.u_mid else null end) noldt1"
"0","  from dl.umid_pv a"
"0","  left outer join"
"0","  dl.umid_pv b on a.u_mid=b.u_mid		"
"0","  where  a.dt>='"",ldateend.str,""' group by a.dt"")"
"2","Warning messages:
"
"2","1: "
"2","In grepl(""\n"", lines, fixed = TRUE) :"
"2","
 "
"2"," input string 1 is invalid in this locale
"
"2","2: "
"2","In grepl(""\n"", lines, fixed = TRUE) :"
"2","
 "
"2"," input string 1 is invalid in this locale
"
"2","3: "
"2","In grepl(""\n"", lines, fixed = TRUE) :"
"2","
 "
"2"," input string 1 is invalid in this locale
"
"2","4: "
"2","In grepl(""\n"", lines, fixed = TRUE) :"
"2","
 "
"2"," input string 1 is invalid in this locale
"
"2","5: "
"2","In strsplit(code, ""\n"", fixed = TRUE) :"
"2","
 "
"2"," input string 1 is invalid in this locale
"
"0","survival = read_data_impala_general(survival_sql)"
"0","survival = survival[order(survival$dt),]"
"0","survival = survival[-nrow(survival),]"
"0","survival$fdt = as.factor(survival$dt)"
"0","par(bg = 'black')"
"0","colors = rainbow(3)"
"0","#考虑survival,!!须注意最后一天"
"0","ylarge = max(max(survival$t1/survival$t),max(survival$newt1/survival$newuv),max(survival$noldt1/survival$olduv))"
"0","matrix = as.matrix(cbind(newsurvival = survival$newt1/survival$newuv,oldsurvival = survival$noldt1/survival$olduv, totalsurvival = survival$t1/survival$t))"
"0","matrix = t(matrix)"
"0","#考虑人均pv"
"0","par(bg = 'white')"
"0","colors <- rainbow(3)"
"0","dates <- survival$dt"
"0","stacks <- colors"
"0","# Create the bar chart."
"0","barplot(matrix,main=paste0(activity_name,""留存率""),names.arg=dates,xlab=""date"",ylab=""留存率"",col=colors,beside = TRUE)"
