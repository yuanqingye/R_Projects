"0","time_span_sql = paste0(""select dt,"
"0","  avg(persvg) totalavg,"
"0","  avg(case when isnew ='new' then persvg else null end) newavg,"
"0","  avg(case when isnew ='old' then persvg else null end) oldavg"
"0","from"
"0","("
"0","  select a.dt,a.u_mid,"
"0","  sum(CAST(p_stay_time AS INT))/1000/60 persvg,"
"0","  case when regexp_replace(to_date(firstonlinetime),'-','')=CAST(a.dt AS STRING) then 'new' else 'old' end isnew "
"0","  from "
"0","  ods.ods_app_pageview_info a "
"0","  left outer join "
"0","  dl.umid_firstonlinetime b on a.u_mid=b.u_mid "
"0","  where a.dt>="",datestart.str,"" and b.dt='"",dateend.str,""' and"
"0","  p_domain='mmall.com' and service like '%staytime%' and substr(a.u_mid,1,2)!='a_' and path='z'  and l_city!='测试'"
"0","  and p_type not in ('page.closedown','page.wakeup','page.activate.main') and length(p_stay_time)<=7"
"0","  group by a.dt,a.u_mid,case when regexp_replace(to_date(firstonlinetime),'-','')=CAST(a.dt AS STRING) then 'new' else 'old' end "
"0",")a group by dt"")"
"0","  time_span = read_data_impala_general(time_span_sql)"
"0","  time_span = time_span[order(time_span$dt),]"
"0","  # write.xlsx(time_span,""~/data/uc_analysis/time_span.xlsx"")"
"0","  time_span$fdt = as.factor(time_span$dt)"
"0","  time_span.new = time_span[,-1]"
"0","  timespan.m <- melt(time_span.new)"
"2","Using fdt as id variables
"
"0","  timespan.m <- ddply(timespan.m, .(variable), transform,rescale = rescale(value))"
"0","  timespan.m$dates = str_sub(as.character(timespan.m$fdt),5,8)"
"0","  timespan.m$dates = factor(timespan.m$dates, levels = timespan.m$dates)"
"2","duplicated levels in factors are deprecated"
"0","  names(timespan.m) = c(""fdt"",""old_new_user"",""time_span"",""rescale"",""dates"")"
"0","# (p <- ggplot(timespan.m, aes(dates,old_new_user)) + geom_tile(aes(fill = time_span),colour = ""white"") + scale_fill_gradient(low = ""white"",high = ""purple""))"
"0","  p <- ggplot(timespan.m, aes(dates,old_new_user)) + geom_tile(aes(fill = time_span),colour = ""white"") + scale_fill_gradient(low = ""white"",high = ""purple"")"
"0","  df = as.data.frame(t(time_span.new))"
"0","  colnames(df) = time_span.new$fdt"
"0","  df = df[-nrow(df),]"
"0","  tt <- ttheme_default(colhead=list(fg_params = list(parse=TRUE)))"
"0","  tbl1 <- tableGrob(df[,1:round(ncol(df)/2)], rows=rownames(df), theme=tt)"
"0","  tbl2 <- tableGrob(df[,(round(ncol(df)/2)+1):ncol(df)], rows=rownames(df), theme=tt)"
"0","# Plot chart and table into one object"
"0","  grid.arrange(p, tbl1,tbl2,nrow=3,as.table=TRUE"
"0","             # ,heights=c(3,1)"
"0","             )"
